# contents of file
name: Merge branch into main

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to merge into main'
        required: true
      merge_method:
        description: 'Merge method: merge (default) or squash or rebase'
        required: false
        default: 'merge'

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch branch to merge
        run: |
          echo "Fetching branch: ${{ github.event.inputs.branch }}"
          git fetch origin "${{ github.event.inputs.branch }}":"refs/remotes/origin/${{ github.event.inputs.branch }}" || true

      - name: Attempt merge
        run: |
          set -e
          MERGE_METHOD="${{ github.event.inputs.merge_method }}"
          echo "Using merge method: $MERGE_METHOD"
          # Make sure we have the latest main
          git checkout main
          git reset --hard origin/main
          # Try merge
          if [ "$MERGE_METHOD" = "squash" ]; then
            git merge --squash "origin/${{ github.event.inputs.branch }}"
            git commit -m "Squash merge '${{ github.event.inputs.branch }}' into main"
          elif [ "$MERGE_METHOD" = "rebase" ]; then
            git rebase "origin/${{ github.event.inputs.branch }}" || { echo "Rebase failed"; exit 1; }
            git push origin main --force-with-lease
            exit 0
          else
            git merge --no-ff --no-edit "origin/${{ github.event.inputs.branch }}" || true
            # If there are merge conflicts, abort and exit non-zero
            if git ls-files -u | grep -q .; then
              echo "::error::Merge conflicts detected. Manual resolution required."
              git merge --abort || true
              exit 1
            fi
            git commit --no-edit || true
          fi

      - name: Push updated main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin main
